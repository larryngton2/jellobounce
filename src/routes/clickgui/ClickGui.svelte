<script lang="ts">
  import { onMount } from "svelte";
  import {
    getGameWindow,
    getModules,
    getModuleSettings,
  } from "../../integration/rest";
  import { groupByCategory } from "../../integration/util";
  import type { GroupedModules, Module } from "../../integration/types";
  import Panel from "./Panel.svelte";
  import Search from "./Search.svelte";
  import Description from "./Description.svelte";
  import { fade, scale } from "svelte/transition";
  import { listen } from "../../integration/ws";
  import type {
    ClickGuiScaleChangeEvent,
    ScaleFactorChangeEvent,
  } from "../../integration/events";
  import { scaleFactor } from "./clickgui_store";
  import { expoOut } from "svelte/easing";

  let categories: GroupedModules = {};
  let modules: Module[] = [];
  let minecraftScaleFactor = 2;
  let clickGuiScaleFactor = 1;
  $: scaleFactor.set(minecraftScaleFactor * clickGuiScaleFactor);

  onMount(async () => {
    const gameWindow = await getGameWindow();
    minecraftScaleFactor = gameWindow.scaleFactor;

    modules = await getModules();
    categories = groupByCategory(modules);

    const clickGuiSettings = await getModuleSettings("ClickGUI");
    clickGuiScaleFactor =
      (clickGuiSettings.value.find((v) => v.name === "Scale")
        ?.value as number) ?? 1;
  });

  listen("scaleFactorChange", (e: ScaleFactorChangeEvent) => {
    minecraftScaleFactor = e.scaleFactor;
  });

  listen("clickGuiScaleChange", (e: ClickGuiScaleChangeEvent) => {
    clickGuiScaleFactor = e.value;
  });
</script>

<div class="background" transition:fade|global={{ duration: 700 }} />
<div
  class="clickgui"
  transition:scale|global={{ duration: 500, easing: expoOut }}
  style="transform: scale({$scaleFactor * 50}%); width: {(2 / $scaleFactor) *
    100}vw; height: {(2 / $scaleFactor) * 100}vh;"
>
  <Description />
  <Search modules={structuredClone(modules)} />
  <Panel {categories} />
</div>

<style lang="scss">
  .background {
    background-color: rgba(black, 0.5);
    width: 100%;
    height: 100%;
    position: absolute;
    left: 0%;
    top: 0%;
  }
  .clickgui {
    overflow: hidden;
    position: relative;
    will-change: opacity;
    z-index: 1;
  }
</style>
